<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SnapTrack â€” Screenshot Optimized</title>
<style>
  :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  body { margin: 0; background: #0f1115; color: #e8e8ea; }
  header { padding: 16px 20px; border-bottom: 1px solid #22262e; }
  .wrap { max-width: 900px; margin: 0 auto; padding: 16px; }
  h1 { font-size: 20px; margin: 0; letter-spacing: .3px; }
  .card { background: #141821; border: 1px solid #22262e; border-radius: 12px; padding: 14px; margin: 14px 0; }
  .grid { display: grid; gap: 12px; }
  @media(min-width: 760px){ .grid-2 { grid-template-columns: 1fr 1fr; } }
  button { background: #2b7fff; color:#fff; border:none; border-radius:10px; padding:12px 14px; font-weight:600; cursor:pointer; }
  button.ghost { background:#202633; color:#e8e8ea; }
  input[type="text"]{ width:100%; padding:12px 14px; background:#0f131c; border:1px solid #22262e; border-radius:10px; color:#e8e8ea; font-size:16px; }
  .row { display:flex; gap:10px; flex-wrap: wrap; align-items:center; }
  .hint { color:#a6abb5; font-size:13px; }
  .pill { display:inline-flex; align-items:center; gap:8px; border:1px solid #2a2f3c; padding:8px 10px; border-radius:999px; margin:6px 6px 0 0; background:#0f131c; }
  .ok { color: #9fffb2; } .warn { color: #ffd08a; } .err { color: #ff8fa3; }
  img#preview { max-width:100%; border-radius:10px; border:1px solid #22262e; }
  progress { width:100%; height:10px; display:none; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
</style>
</head>
<body>
<header><div class="wrap"><h1>ðŸ“¦ SnapTrack â€” Screenshotâ€‘Optimized OCR</h1></div></header>
<main class="wrap">
  <div class="card grid grid-2">
    <div class="grid">
      <div class="row">
        <input id="file" type="file" accept="image/*" capture="environment" hidden />
        <button id="chooseBtn">Choose Photo</button>
        <button id="clearBtn" class="ghost">Clear</button>
      </div>
      <div class="hint">Best for single-line screenshots of the number. (We pad & upscale to avoid chopping the first/last digit.)</div>
      <img id="preview" alt="" />
    </div>
    <div class="grid">
      <div>
        <label class="hint">Manual entry (autoâ€‘filled from OCR)</label>
        <input id="manual" type="text" inputmode="numeric" placeholder="22â€“30 digit tracking number or CSVâ€¦" />
        <label class="hint" style="display:inline-flex;gap:.5rem;align-items:center;margin-top:8px;">
          <input id="only30" type="checkbox" checked> Only accept exact 30â€‘digit
        </label>
      </div>
      <div class="row">
        <button id="trackBtn">Track on USPS</button>
        <button id="copyBtn" class="ghost">Copy</button>
      </div>
      <div id="status" class="hint">Idle.</div>
      <progress id="prog" max="1" value="0"></progress>
    </div>
  </div>

  <div class="card">
    <div class="hint">Candidates (tap to use)</div>
    <div id="candidates"></div>
  </div>

  <div class="card">
    <details open>
      <summary class="hint">Debug (OCR text & candidates)</summary>
      <pre id="debug" class="mono" style="white-space:pre-wrap;"></pre>
    </details>
  </div>

  <div class="hint">Privacy: OCR runs in your browser; images do not leave your device.</div>
</main>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<script>
const fileInput = document.getElementById('file');
const chooseBtn = document.getElementById('chooseBtn');
const clearBtn = document.getElementById('clearBtn');
const preview = document.getElementById('preview');
const prog = document.getElementById('prog');
const statusEl = document.getElementById('status');
const debug = document.getElementById('debug');
const candidatesBox = document.getElementById('candidates');
const manual = document.getElementById('manual');
const trackBtn = document.getElementById('trackBtn');
const copyBtn = document.getElementById('copyBtn');
const only30 = document.getElementById('only30');

only30.checked = localStorage.getItem('snaptrack_only30_ss') !== 'false';
only30.addEventListener('change', ()=>localStorage.setItem('snaptrack_only30_ss', String(only30.checked)));

function setStatus(t,c=''){ statusEl.className='hint '+c; statusEl.textContent=t; }
function usps(n){ return `https://tools.usps.com/go/TrackConfirmAction?qtc_tLabels1=${encodeURIComponent(n)}`; }

function render(list){
  candidatesBox.innerHTML='';
  if(!list.length){ candidatesBox.innerHTML='<span class="hint">No candidates.</span>'; return; }
  list.forEach(n=>{
    const pill=document.createElement('span');
    pill.className='pill mono'; pill.textContent=n;
    pill.addEventListener('click',()=>{ manual.value=n; setStatus('Number set from candidates.','ok'); });
    candidatesBox.appendChild(pill);
  });
}

// --------- 1) Pad & upscale to protect edge digits ---------
async function padAndScale(blob, padRatio = 0.10, scale = 2) {
  const img = await createImageBitmap(blob);
  const padX = Math.floor(img.width * padRatio);
  const padY = Math.floor(img.height * padRatio);

  const c = document.createElement('canvas');
  c.width = (img.width + padX*2) * scale;
  c.height = (img.height + padY*2) * scale;
  const ctx = c.getContext('2d');

  ctx.fillStyle = '#fff'; // white background aids OCR
  ctx.fillRect(0, 0, c.width, c.height);
  ctx.imageSmoothingEnabled = true;
  ctx.imageSmoothingQuality = 'high';

  ctx.drawImage(
    img,
    0, 0, img.width, img.height,
    padX*scale, padY*scale, img.width*scale, img.height*scale
  );

  return await new Promise(r => c.toBlob(b => r(b), 'image/png'));
}

// --------- 3) Extractor: favor longest run for screenshots ---------
function extractUSPSCandidates(raw){
  const t = (raw || '');
  const lines = t.split('\n').filter(s => s.trim().length);
  const runs = (t.match(/\d{2,}/g) || []);

  // If it's likely a screenshot (<=2 lines), take the longest 20â€“34 run
  if (lines.length <= 2) {
    let longest = '';
    for (const r of runs) if (r.length > longest.length) longest = r;
    if (longest.length >= 20 && longest.length <= 34) return [longest];
  }

  // Otherwise collect all long runs and dedupe
  const out = Array.from(new Set(runs.filter(r => r.length >= 20 && r.length <= 34)));
  // Prefer 30-digit, then 420+ZIP, then length
  out.sort((a,b)=>{
    const a30 = a.length===30, b30 = b.length===30;
    if (a30 !== b30) return b30 - a30;
    const az = /^420\d{5}/.test(a), bz = /^420\d{5}/.test(b);
    if (az !== bz) return bz - az;
    return b.length - a.length;
  });
  return out;
}

async function runOCR(blob){
  if(!blob) return;
  preview.src = URL.createObjectURL(blob);
  prog.style.display='block'; prog.value=0; setStatus('Running OCRâ€¦');

  try{
    const worker = await Tesseract.createWorker({ logger:m=>{
      if(m.status==='recognizing text' && m.progress!=null) prog.value=m.progress;
    }});
    await worker.loadLanguage('eng');
    await worker.initialize('eng');
    await worker.setParameters({
      tessedit_char_whitelist:'0123456789',
      preserve_interword_spaces:'1',
      user_defined_dpi:'300',
      tessedit_pageseg_mode:'7' // SINGLE LINE first
    });

    // PASS A: padded & upscaled single-line
    const padded = await padAndScale(blob, 0.10, 2);
    const a = await worker.recognize(padded);

    // If too short, fallback to block mode on the same padded image
    let text = (a.data.text || '').trim();
    if (text.replace(/[^\d]/g,'').length < 20) {
      await worker.setParameters({ tessedit_pageseg_mode:'6' }); // block of text
      const b = await worker.recognize(padded);
      text = ((a.data.text||'') + '\n' + (b.data.text||'')).trim();
    }
    await worker.terminate();

    let cands = extractUSPSCandidates(text);
    if(only30.checked) cands = cands.filter(n=>/^\d{30}$/.test(n));

    debug.textContent = text + "\n\n[Candidates] " + (cands.length?cands.join(', '):'none');
    render(cands);
    if(cands.length){ manual.value=cands.join(', '); setStatus(`Found ${cands.length} candidate(s).`,'ok'); }
    else setStatus('No clear tracking numbers. Try a tighter crop or better light.','warn');
  }catch(e){
    prog.style.display='none'; setStatus('OCR failed.','err'); debug.textContent=String(e&&e.message||e);
  }
}

// ---- UI wiring ----
chooseBtn.addEventListener('click',()=>fileInput.click());
fileInput.addEventListener('change', async e=>{
  const f=e.target.files&&e.target.files[0]; if(!f) return;
  candidatesBox.innerHTML=''; manual.value=''; await runOCR(f);
});
clearBtn.addEventListener('click',()=>{
  preview.removeAttribute('src'); fileInput.value='';
  candidatesBox.innerHTML=''; manual.value=''; debug.textContent='';
  prog.style.display='none'; setStatus('Cleared.');
});
copyBtn.addEventListener('click', async ()=>{
  const v=manual.value.trim(); if(!v) return setStatus('Nothing to copy.','warn');
  try{ await navigator.clipboard.writeText(v); setStatus('Copied.','ok'); }catch{ setStatus('Copy failed.','err'); }
});
trackBtn.addEventListener('click',()=>{
  let nums = manual.value.split(/[\s,]+/).map(s=>s.trim()).filter(Boolean);
  if(only30.checked) nums = nums.filter(n=>/^\d{30}$/.test(n));
  if(!nums.length) return setStatus('Enter or select a number first.','warn');
  nums.forEach(n=>window.open(usps(n),'_blank','noopener,noreferrer'));
  setStatus(`Opened ${nums.length} tracking page(s).`,'ok');
});
</script>
</body>
</html>

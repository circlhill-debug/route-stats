<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Route Stats — Live Dashboard</title>
<style>
  :root{
    --bg:#0f1115; --card:#141821; --border:#22262e; --text:#e8e8ea; --muted:#9aa0aa; --brand:#2b7fff;
    --good:#7CE38B; --warn:#FFD27A; --bad:#FF8FA1
  }
  *{box-sizing:border-box}
  body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Inter,Segoe UI,Roboto,Arial,sans-serif }
  header{ border-bottom:1px solid var(--border); padding:14px 16px }
  .wrap{ max-width:1120px; margin:0 auto; padding:16px }
  h1{ margin:0; font-size:20px; letter-spacing:.3px }
  .grid{ display:grid; gap:12px }
  @media(min-width:1000px){ .grid-2{ grid-template-columns:1.1fr .9fr } }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px }
  label{ font-size:13px; color:var(--muted) }
  input,select,textarea{ width:100%; padding:12px; background:transparent; border:1px solid var(--border); border-radius:10px; color:var(--text); font-size:15px }
  button{ background:var(--brand); color:#fff; border:0; border-radius:10px; padding:10px 14px; font-weight:700; cursor:pointer }
  button.ghost{ background:transparent; color:var(--text); border:1px solid var(--border) }
  small{ color:var(--muted) }
  table{ width:100%; border-collapse:collapse }
  th,td{ border-bottom:1px solid var(--border); padding:8px 6px; text-align:left }
  th{ color:var(--muted); font-weight:600 }
  .right{ text-align:right }
  .pill{ display:inline-flex; gap:8px; align-items:center; border:1px solid var(--border); padding:6px 8px; border-radius:999px; background:transparent }
  .stat{ display:flex; flex-direction:column; gap:4px; padding:10px; border:1px solid var(--border); border-radius:12px; min-width:140px }
  .up{ color:var(--good) } .down{ color:var(--bad) } .warn{ color:var(--warn) }
  canvas{ background:transparent; border:1px solid var(--border); border-radius:10px; padding:8px }
  .fab{ position:fixed; right:16px; bottom:16px; z-index:10 }
  #diag{ position:sticky; top:0; z-index:999; background:#111; color:#ddd; font:12px/1.35 system-ui; padding:6px 10px; border-bottom:1px solid #222 }
  #diag b{ color:#fff }
  tr.light td{ background:linear-gradient(90deg, rgba(124,227,139,.07), transparent) }
  tr.heavy td{ background:linear-gradient(90deg, rgba(255,143,161,.10), transparent) }
  tr.typical td{ background:linear-gradient(90deg, rgba(255,210,122,.08), transparent) }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
  dialog{ background:var(--card); color:var(--text); border:1px solid var(--border); border-radius:12px; padding:16px }
</style>
</head>
<body>
<div id="diag">ROUTE STATS · Supabase: <b id="dConn">…</b> · Auth: <b id="dAuth">…</b> · Write: <b id="dWrite">—</b></div>
<header>
  <div class="wrap row" style="justify-content:space-between">
    <h1>📈 ROUTE STATS — Live Dashboard</h1>
    <div class="row">
      <button id="linkBtn" class="ghost">Link devices (magic link)</button>
      <button id="signOut" class="ghost">Sign out</button>
    </div>
  </div>
</header>

<main class="wrap grid grid-2">
  <!-- SNAPSHOT -->
  <section class="card">
    <div class="row" style="justify-content:space-between;align-items:flex-start;flex-wrap:wrap">
      <div class="row" style="gap:8px;align-items:stretch">
        <div class="stat">
          <small>Expected End (today)</small>
          <strong id="expEnd" style="font-size:20px">—</strong>
          <small id="expMeta" style="color:var(--muted)">DOW avg —</small>
        </div>
        <div class="stat">
          <small>Volume</small>
          <strong id="badgeVolume" style="font-size:20px">—</strong>
          <small class="muted">parcels + 0.33×letters</small>
        </div>
        <div class="stat">
          <small>Route Eff.</small>
          <strong id="badgeRouteEff" style="font-size:20px">—</strong>
          <small class="muted">vs weekday baseline</small>
        </div>
        <div class="stat">
          <small>Overall</small>
          <strong id="badgeOverall" style="font-size:20px">—</strong>
          <small class="muted">office + route vs expected</small>
        </div>
      </div>
      <div class="row" style="gap:8px;align-items:stretch">
        <div class="stat">
          <small>Hours (week)</small>
          <div><strong id="wkHours">—</strong> <span id="wkHoursDelta" class="pill">—</span></div>
        </div>
        <div class="stat">
          <small>Parcels (week)</small>
          <div><strong id="wkParcels">—</strong> <span id="wkParcelsDelta" class="pill">—</span></div>
        </div>
        <div class="stat">
          <small>Letters (week)</small>
          <div><strong id="wkLetters">—</strong> <span id="wkLettersDelta" class="pill">—</span></div>
        </div>
      </div>
    </div>
  </section>

  <!-- FORM -->
  <section class="card">
    <h3 style="margin:0 0 8px 0">Add Entry</h3>

    <div class="row" style="margin:6px 0 10px 0">
      <button id="btnStartNow" class="ghost">Start (now)</button>
      <button id="btnStreetNow" class="ghost">Hit Street (now)</button>
      <button id="btnClockNow" class="ghost">Clock Out (now)</button>
    </div>

    <div class="grid" style="grid-template-columns:repeat(2,1fr);gap:10px">
      <div><label>Date</label><input id="date" type="date"></div>

      <div>
        <label>Route</label>
        <input id="route" type="text" value="R1" readonly>
      </div>

      <div><label>Start (defaults 08:00)</label><div class="row"><input id="start" type="time" value="08:00"><button id="btnStartNow2" class="ghost">Now</button></div></div>
      <div><label>Hit Street</label><div class="row"><input id="departTime" type="time" placeholder="--:--"><button id="btnStreetNow2" class="ghost">Now</button></div></div>

      <div><label>Return (optional)</label><div class="row"><input id="returnTime" type="time" placeholder="--:--"><button id="btnReturnNow" class="ghost">Now</button></div></div>
      <div><label>Clock Out</label><div class="row"><input id="end" type="time" placeholder="--:--"><button id="btnClockNow2" class="ghost">Now</button></div></div>

      <div><label>Parcels</label><input id="parcels" type="number" min="0" value="0"></div>
      <div><label>Letters</label><input id="letters" type="number" min="0" value="0"></div>
      <div><label>Miles</label><input id="miles" type="number" step="0.1" min="0" value="0"></div>

      <div>
        <label>Weather</label>
        <div class="row">
          <select id="weather" style="min-width:160px">
            <option value="">—</option>
            <option>☀️ Sunny</option>
            <option>⛅ Partly Cloudy</option>
            <option>🌧️ Rain</option>
            <option>❄️ Snow</option>
            <option>💨 Windy</option>
            <option>🌫️ Fog</option>
            <option>Other</option>
          </select>
          <select id="temp" title="Temp (°F)" style="min-width:110px">
            <option value="">Temp (°F)</option>
            <option>20</option><option>25</option><option>30</option><option>35</option>
            <option>40</option><option>45</option><option>50</option><option>55</option>
            <option>60</option><option>65</option><option>70</option><option>75</option>
            <option>80</option><option>85</option><option>90</option><option>95</option>
          </select>
        </div>
      </div>

      <div>
        <label>Box holders</label>
        <select id="boxholders">
          <option value="">—</option>
          <option>None</option>
          <option>Light</option>
          <option>Medium</option>
          <option>Heavy</option>
        </select>
      </div>

      <div><label>Mood</label><select id="mood"><option value="">—</option><option>🔥 dialed in</option><option>🙂 good</option><option>😐 meh</option><option>🥵 cooked</option><option>🌧️ soggy</option><option>🛑 off</option></select></div>
      <div style="grid-column:1/-1"><label>Notes</label><textarea id="notes" rows="2" placeholder="Anything notable…"></textarea></div>

      <div class="row" style="grid-column:1/-1;justify-content:space-between;align-items:center">
        <label class="pill"><input id="offDay" type="checkbox"> Off day</label>
        <div class="row"><span class="pill"><small>Office:</small> <b id="officeH">—</b></span><span class="pill"><small>Route:</small> <b id="routeH">—</b></span><span class="pill"><small>Total:</small> <b id="totalH">—</b></span></div>
        <div class="row"><button id="save">Save</button></div>
      </div>
    </div>
  </section>

  <!-- CHARTS -->
  <section class="card"><h3 style="margin:0 0 8px 0">Averages by Day of Week</h3><canvas id="dowChart" height="180"></canvas></section>
  <section class="card"><h3 style="margin:0 0 8px 0">Parcels Over Time</h3><canvas id="parcelsChart" height="180"></canvas></section>
  <section class="card"><h3 style="margin:0 0 8px 0">Letters Over Time</h3><canvas id="lettersChart" height="180"></canvas></section>

  <!-- TABLE -->
  <section class="card" style="grid-column:1/-1">
    <div class="row" style="justify-content:space-between"><h3 style="margin:0">Recent Entries</h3><button id="exportCsv" class="ghost">Export CSV</button></div>
    <div style="max-height:360px;overflow:auto;border:1px solid var(--border);border-radius:10px">
      <table id="tbl"><thead><tr>
        <th>Date</th><th>Route</th><th>Status</th><th class="right">Office (h)</th><th class="right">Route (h)</th><th class="right">Total (h)</th><th class="right">Parcels</th><th class="right">Letters</th><th class="right">Miles</th><th>Weather</th>
      </tr></thead><tbody></tbody></table>
    </div>
  </section>
</main>

<!-- Magic link dialog -->
<dialog id="linkDlg">
  <form method="dialog" class="grid" style="min-width:320px;gap:10px">
    <h3 style="margin:0">Link devices</h3>
    <small>Enter your email, then tap the magic link in your inbox on each device.</small>
    <input id="email" type="email" placeholder="you@example.com" required>
    <div class="row" style="justify-content:flex-end;gap:8px"><button class="ghost" value="cancel">Cancel</button><button id="sendLink">Send link</button></div>
  </form>
</dialog>

<button class="fab" id="fab">+ Add Entry</button>

<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ==== YOUR SUPABASE VALUES (PUT YOURS HERE) ====
  const SUPABASE_URL  = 'https://YOUR-REF.supabase.co';
  const SUPABASE_ANON = 'YOUR-ANON-KEY';
  // ===============================================

  // ---- Timezone (DST-aware) ----
  const ZONE = "America/Detroit";

  // Supabase + helpers
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON, { auth: { persistSession:true } });
  const $ = id => document.getElementById(id);
  const DateTime = luxon.DateTime;

  // Diagnostics
  const dConn=$('dConn'), dAuth=$('dAuth'), dWrite=$('dWrite');
  (async ()=>{ try{ await fetch(SUPABASE_URL,{mode:'no-cors'}); dConn.textContent='Connected'; }catch{ dConn.textContent='Error'; }})();

  // Anonymous session by default
  (async function ensureSession(){
    const { data:{ session } } = await sb.auth.getSession();
    if (!session) { await sb.auth.signInAnonymously().catch(()=>{}); }
    const { data:{ user } } = await sb.auth.getUser();
    dAuth.textContent = user? 'Session' : 'No session';
  })();

  // Magic link flow
  const linkBtn=$('linkBtn'), linkDlg=$('linkDlg'), sendLink=$('sendLink'), email=$('email');
  linkBtn.addEventListener('click', ()=> linkDlg.showModal());
  sendLink.addEventListener('click', async (e)=>{
    e.preventDefault();
    const redirectTo = location.origin + location.pathname;
    const { error } = await sb.auth.signInWithOtp({ email: email.value, options:{ emailRedirectTo: redirectTo } });
    if (error) alert(error.message); else { alert('Check your email for the magic link.'); linkDlg.close(); }
  });
  $('signOut').addEventListener('click', ()=> sb.auth.signOut().then(()=>location.reload()));

  // Elements
  const date=$('date'), route=$('route'), start=$('start'), end=$('end'), departTime=$('departTime'), returnTime=$('returnTime');
  const parcels=$('parcels'), letters=$('letters'), miles=$('miles'), mood=$('mood'), notes=$('notes');
  const weather=$('weather'), temp=$('temp'), boxholders=$('boxholders');
  const offDay=$('offDay');
  const officeH=$('officeH'), routeH=$('routeH'), totalH=$('totalH');
  const expEnd=$('expEnd'), expMeta=$('expMeta');
  const badgeVolume=$('badgeVolume'), badgeRouteEff=$('badgeRouteEff'), badgeOverall=$('badgeOverall');

  // Tooltips
  badgeVolume.title   = 'Volume = parcels + 0.33×letters vs your recent history (0–10)';
  badgeRouteEff.title = 'Route Efficiency = today’s street hours vs typical for this weekday (0–10)';
  badgeOverall.title  = 'Overall = total hours (office+route) vs expected (weekday avg early on)';

  // TZ-safe helpers
  function todayStr(){ return DateTime.now().setZone(ZONE).toISODate(); }
  function hhmmNow(){ const d = DateTime.now().setZone(ZONE); return `${String(d.hour).padStart(2,'0')}:${String(d.minute).padStart(2,'0')}`; }
  function diffHours(d, t1, t2){
    if(!t1||!t2) return null;
    const a = DateTime.fromISO(`${d}T${t1}`, { zone: ZONE });
    const b = DateTime.fromISO(`${d}T${t2}`, { zone: ZONE });
    let h = (b.toMillis()-a.toMillis())/3.6e6;
    if (h < 0) h += 24;
    return Math.round(h*100)/100;
  }

  // Defaults
  date.value = todayStr();
  route.value = "R1";

  function computeBreakdown(){
    if (offDay.checked){ officeH.textContent='0.00'; routeH.textContent='0.00'; totalH.textContent='0.00'; return 0; }
    const d=date.value; const s=start.value||'08:00';
    const off=diffHours(d, s, departTime.value);
    const rte=diffHours(d, departTime.value, end.value);
    const tot=(off??0)+(rte??0);
    officeH.textContent = off!=null? off.toFixed(2) : '—';
    routeH.textContent  = rte!=null? rte.toFixed(2) : '—';
    totalH.textContent  = (off!=null||rte!=null)? tot.toFixed(2) : '—';
    return tot;
  }

  // Quick buttons
  function setNow(el){ el.value=hhmmNow(); computeBreakdown(); }
  $('btnStartNow').addEventListener('click',()=>{ if(!start.value) setNow(start); });
  $('btnStreetNow').addEventListener('click',()=> setNow(departTime));
  $('btnClockNow').addEventListener('click',()=> setNow(end));
  $('btnStartNow2').addEventListener('click',()=> setNow(start));
  $('btnStreetNow2').addEventListener('click',()=> setNow(departTime));
  $('btnReturnNow').addEventListener('click',()=> setNow(returnTime));
  $('btnClockNow2').addEventListener('click',()=> setNow(end));

  // Off day UX
  offDay.addEventListener('change', ()=>{ if(offDay.checked){ end.value=hhmmNow(); parcels.value=letters.value=miles.value=0; mood.value='🛑 off'; computeBreakdown(); }});

  ;[date,start,departTime,returnTime,end,parcels,letters,miles,offDay,weather,temp,boxholders]
    .forEach(el=> el.addEventListener('input', computeBreakdown));

  // Data plumbing
  function weatherString(){
    const parts=[];
    if (weather?.value) parts.push(weather.value);
    if (temp?.value) parts.push(`${temp.value}°F`);
    if (boxholders?.value) parts.push(`Box: ${boxholders.value}`);
    return parts.length? parts.join(' · ') : null;
  }

  function collectPayload(userId){
    const d = date.value;
    const s = start.value || '08:00';
    const off = diffHours(d, s, departTime.value);
    const rte = diffHours(d, departTime.value, end.value);
    const tot = offDay.checked ? 0 : ((off??0)+(rte??0));
    return {
      user_id:      userId,
      work_date:    d,                 // local date (no UTC shift)
      route:        "R1",
      start_time:   offDay.checked ? null : (s||null),
      end_time:     offDay.checked ? null : (end.value||null),
      hours:        offDay.checked ? 0 : (tot||null),
      parcels:      offDay.checked ? 0 : (+parcels.value||0),
      letters:      offDay.checked ? 0 : (+letters.value||0),
      miles:        offDay.checked ? 0 : (+miles.value||0),
      mood:         offDay.checked ? '🛑 off' : (mood.value||null),
      notes:        notes.value||null,
      status:       offDay.checked ? 'off' : 'worked',
      office_start: s||null,
      depart_time:  departTime.value||null,
      return_time:  returnTime.value||null,
      office_minutes: off!=null? (off).toFixed(2) : null,
      route_minutes:  rte!=null? (rte).toFixed(2) : null,
      weather_json: weatherString()
    };
  }

  function fillForm(r){
    start.value       = r.start_time || '08:00';
    end.value         = r.end_time   || '';
    departTime.value  = r.depart_time || '';
    returnTime.value  = r.return_time || '';
    parcels.value     = r.parcels || 0;
    letters.value     = r.letters || 0;
    miles.value       = r.miles   || 0;
    mood.value        = r.mood    || '';
    notes.value       = r.notes   || '';
    offDay.checked    = (r.status === 'off');

    // parse weather combo "⛅ Partly Cloudy · 55°F · Box: Medium"
    const raw = r.weather_json || '';
    if (!raw){ if(temp) temp.value=''; if(boxholders) boxholders.value=''; weather.value=''; }
    else {
      const parts = String(raw).split('·').map(s=>s.trim());
      let w='', t='', b='';
      for (const p of parts){
        if (/°F$/.test(p)) t = p.replace('°F','').trim();
        else if (/^Box:/i.test(p)) b = p.split(':').slice(1).join(':').trim();
        else w = p;
      }
      weather.value = w || '';
      if (temp) temp.value = t || '';
      if (boxholders) boxholders.value = b || '';
    }

    try { computeBreakdown(); } catch(_){}
  }

  let editingKey = null; // { user_id, work_date }

  async function loadByDate(){
    editingKey = null;
    const { data:{ user } } = await sb.auth.getUser();
    if (!user) return;
    const d = date.value;
    if (!d) return;

    const { data, error } = await sb
      .from('entries')
      .select('*')
      .eq('user_id', user.id)
      .eq('work_date', d)
      .limit(1)
      .maybeSingle();

    if (error && error.code !== 'PGRST116') { console.error(error); return; }

    const saveBtn = $('save');
    if (data) {
      editingKey = { user_id: user.id, work_date: d };
      fillForm(data);
      saveBtn.textContent = 'Update';
      saveBtn.classList.remove('ghost'); // BLUE
    } else {
      saveBtn.textContent = 'Save';
      saveBtn.classList.remove('ghost'); // BLUE
    }
  }

  date.addEventListener('change', loadByDate);

  // Replace Save handler (insert or update)
  (function replaceSave(){
    const btn = $('save');
    const clone = btn.cloneNode(true);
    btn.parentNode.replaceChild(clone, btn);

    clone.addEventListener('click', async ()=>{
      const { data:{ user } } = await sb.auth.getUser();
      if (!user) { alert('No session. Try Link devices or refresh.'); return; }

      const payload = collectPayload(user.id);
      let error;
      if (editingKey) {
        ({ error } = await sb.from('entries').update(payload)
          .eq('user_id', editingKey.user_id)
          .eq('work_date', editingKey.work_date));
      } else {
        ({ error } = await sb.from('entries').insert(payload));
      }
      dWrite.textContent = error ? 'Failed' : 'OK';
      if (error){ alert(error.message); return; }

      const rows = await fetchEntries();
      renderTable(rows); buildCharts(rows); buildSnapshot(rows);

      editingKey = { user_id: user.id, work_date: date.value };
      clone.textContent = 'Update';
      clone.classList.remove('ghost'); // BLUE
    });
  })();

  // Fetch & render
  async function fetchEntries(){
    const { data:{ user } } = await sb.auth.getUser(); if(!user) return [];
    const { data, error } = await sb.from('entries').select('*').eq('user_id',user.id).order('work_date',{ascending:false}).limit(365);
    if(error){ console.error(error); return []; } return data;
  }

  function classifyRow(total, avg){ if(total==null||avg==null) return ''; const diff=(total-avg)/avg; if(diff<=-0.15) return 'light'; if(diff>=0.15) return 'heavy'; return 'typical'; }

  function renderTable(rows){
    const tbody=document.querySelector('#tbl tbody'); tbody.innerHTML='';

    // Baselines by DOW using Luxon in local zone
    const byDow=Array.from({length:7},()=>[]);
    rows.forEach(r=>{
      if(r.status==='off') return;
      const h=Number(r.hours||0);
      const dow = DateTime.fromISO(r.work_date,{zone:ZONE}).weekday % 7; // 0..6 Sun..Sat
      if(h>0) byDow[dow].push(h);
    });
    const avgByDow=byDow.map(list=> list.length? (list.reduce((a,b)=>a+b,0)/list.length) : null);

    for(const r of rows){
      const tot=Number(r.hours||0)||null;
      const offH=(r.office_minutes!=null)? Number(r.office_minutes).toFixed(2):'';
      const rteH=(r.route_minutes!=null)? Number(r.route_minutes).toFixed(2):'';
      const dow = DateTime.fromISO(r.work_date,{zone:ZONE}).weekday % 7;
      const avg=avgByDow[dow];
      const cls=classifyRow(tot,avg);

      const tr=document.createElement('tr'); if(cls) tr.classList.add(cls);
      tr.innerHTML = `<td>${r.work_date}</td><td>R1</td><td>${r.status||'worked'}</td>
        <td class="right">${offH}</td><td class="right">${rteH}</td><td class="right">${tot!=null? tot.toFixed(2):''}</td>
        <td class="right">${r.parcels||0}</td><td class="right">${r.letters||0}</td><td class="right">${r.miles||0}</td>
        <td>${r.weather_json||''}</td>`;
      tbody.appendChild(tr);
    }
  }

  // CSV export
  $('exportCsv').addEventListener('click', async ()=>{
    const rows=await fetchEntries();
    const headers=['work_date','route','status','start_time','depart_time','return_time','end_time','hours','office_minutes','route_minutes','parcels','letters','miles','mood','notes','weather_json','created_at'];
    const lines=[headers.join(',')];
    for(const r of rows){
      const vals=headers.map(h=>{const v=(h==='route')?'R1':r[h]; if(v==null) return ''; const s=String(v).replace(/"/g,'""'); return /[",\n]/.test(s)? `"${s}"`: s;});
      lines.push(vals.join(','));
    }
    const blob=new Blob([lines.join('\n')],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='route-stats.csv'; a.click();
  });

  // Charts
  let dowChart, parcelsChart, lettersChart;
  function destroyCharts(){ [dowChart,parcelsChart,lettersChart].forEach(c=>c&&c.destroy()); }

  function buildCharts(rows){
    destroyCharts();
    const workRows=rows.filter(r=>r.status!=='off');

    // DOW averages (total hours) — Luxon + local zone for DOW
    const byDow=Array.from({length:7},()=>({h:0,c:0}));
    for(const r of workRows){
      const h=Number(r.hours||0);
      if(h>0){
        const dow = DateTime.fromISO(r.work_date,{zone:ZONE}).weekday % 7; // 0..6
        byDow[dow].h+=h; byDow[dow].c++;
      }
    }
    const dowLabels=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const dowData=byDow.map(x=> x.c? +(x.h/x.c).toFixed(2):0);
    dowChart=new Chart(document.getElementById('dowChart'),{type:'bar',data:{labels:dowLabels,datasets:[{label:'Avg Total Hours',data:dowData}]},options:{responsive:true,plugins:{legend:{display:false}}}});

    // Time series labels (just use stored local ISO date)
    const sorted=[...rows].sort((a,b)=> a.work_date.localeCompare(b.work_date));
    const labels=sorted.map(r=> r.work_date);

    parcelsChart=new Chart(document.getElementById('parcelsChart'),{
      type:'line',
      data:{ labels, datasets:[{ label:'Parcels', data: sorted.map(r=> +r.parcels||0) }] },
      options:{ responsive:true, plugins:{ legend:{ display:false }}, scales:{x:{ticks:{maxTicksLimit:8}}}}
    });

    lettersChart=new Chart(document.getElementById('lettersChart'),{
      type:'line',
      data:{ labels, datasets:[{ label:'Letters', data: sorted.map(r=> +r.letters||0) }] },
      options:{ responsive:true, plugins:{ legend:{ display:false }}, scales:{x:{ticks:{maxTicksLimit:8}}}}});
  }

  // Snapshot & badges (also TZ-safe for DOW + week math)
  function pct(a,b){ if(!b) return null; return ((a-b)/b)*100; }
  function hhmmFrom(baseDateStr, hours){ if(hours==null) return '—'; const d=DateTime.fromISO(baseDateStr,{zone:ZONE}).set({hour:8,minute:0}); return d.plus({hours}).toFormat('h:mm a'); }
  function startOfWeekSunday(dt){ const shift = dt.weekday % 7; return dt.startOf('day').minus({ days: shift }); }

  function buildSnapshot(rows){
    const today=DateTime.now().setZone(ZONE);
    const dow=today.weekday%7;
    const workRows=rows.filter(r=>r.status!=='off');

    // Baselines by DOW for hours + office share
    const byDow=Array.from({length:7},()=>({h:0,c:0, offShare:[] }));
    for(const r of workRows){
      const h=Number(r.hours||0);
      if(h>0){
        const d=DateTime.fromISO(r.work_date,{zone:ZONE}).weekday % 7;
        byDow[d].h+=h; byDow[d].c++;
        const off=Number(r.office_minutes||0); const rt=Number(r.route_minutes||0); const tot=off+rt; if(tot>0) byDow[d].offShare.push(off/tot);
      }
    }
    const avgH=byDow.map(x=> x.c? x.h/x.c : null);
    const todayAvgH=avgH[dow];
    expEnd.textContent = todayAvgH? hhmmFrom(today.toISODate(), todayAvgH) : '—';
    expMeta.textContent = `${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][dow]} avg ${todayAvgH? todayAvgH.toFixed(2)+'h':'—'}`;

    // Badges
    const lastN = rows.slice(0,30);
    const volMetric = (r)=> (+r.parcels||0) + 0.33*(+r.letters||0);
    const vols = lastN.map(volMetric);
    const v = vols.length? volMetric(rows[0]||{}) : 0;
    const rank = (arr,x)=> { const s=[...arr].sort((a,b)=>a-b); let i=s.findIndex(n=>x<=n); if(i<0) i=s.length; return i/s.length; };
    const volScore = vols.length? Math.round(rank(vols,v)*10) : 0;
    badgeVolume.textContent = `${volScore}/10`;

    // Route efficiency vs same-DOW baseline
    const rhs = workRows.filter(r=> DateTime.fromISO(r.work_date,{zone:ZONE}).weekday%7===dow)
                        .map(r=> +r.route_minutes||0).filter(n=>n>0);
    const rteAvg = rhs.length? (rhs.reduce((a,b)=>a+b,0)/rhs.length) : null;
    const todayRoute = rows[0]? (+rows[0].route_minutes||0) : null;
    const rteScore = (rteAvg && todayRoute!=null && rteAvg>0)? Math.max(0, Math.min(10, Math.round((1 - (todayRoute - rteAvg)/Math.max(1,rteAvg))*10))) : 0;
    badgeRouteEff.textContent = `${rteScore}/10`;

    // Overall vs expected (weekday avg until model)
    const totToday = rows[0]? (+rows[0].hours||0) : 0;
    const exp = todayAvgH || 0;
    const overallScore = exp>0? Math.max(0, Math.min(10, Math.round((1 - (totToday - exp)/Math.max(1,exp))*10))) : 0;
    badgeOverall.textContent = `${overallScore}/10`;

    // Week-over-week tiles
    const startW = startOfWeekSunday(today);
    const lastStart = startW.minus({weeks:1});
    const lastEnd = startW.minus({days:1});
    const inRange=(r,from,to)=>{ const d=DateTime.fromISO(r.work_date,{zone:ZONE}); return d>=from && d<=to; };
    const thisW=workRows.filter(r=> inRange(r,startW,today));
    const lastW=workRows.filter(r=> inRange(r,lastStart,lastEnd));
    const sum=(arr,fn)=>arr.reduce((t,x)=>t+(fn(x)||0),0);
    const hThis=sum(thisW,r=>Number(r.hours||0)); const hLast=sum(lastW,r=>Number(r.hours||0));
    const pThis=sum(thisW,r=>Number(r.parcels||0)); const pLast=sum(lastW,r=>Number(r.parcels||0));
    const lThis=sum(thisW,r=>Number(r.letters||0)); const lLast=sum(lastW,r=>Number(r.letters||0));
    const dh=pct(hThis,hLast), dp=pct(pThis,pLast), dl=pct(lThis,lLast);
    const fmt=p=> p==null? '—' : (p>=0? `↑ ${p.toFixed(0)}%` : `↓ ${Math.abs(p).toFixed(0)}%`);
    $('wkHours').textContent = (hThis||0).toFixed(2);
    $('wkParcels').textContent = (pThis||0).toString();
    $('wkLetters').textContent = (lThis||0).toString();
    const setPill=(el,delta)=>{ el.textContent=fmt(delta); el.className='pill '+(delta==null?'':delta>=0?'up':'down'); };
    setPill($('wkHoursDelta'), dh); setPill($('wkParcelsDelta'), dp); setPill($('wkLettersDelta'), dl);
  }

  // Realtime
  try{
    sb.channel('entries-feed')
      .on('postgres_changes',{event:'*',schema:'public',table:'entries'}, async ()=>{
        const rows=await fetchEntries(); renderTable(rows); buildCharts(rows); buildSnapshot(rows);
      }).subscribe();
  }catch(e){ console.warn('Realtime not enabled:', e?.message||e); }

  // FAB focus
  $('fab').addEventListener('click',()=>{ window.scrollTo({ top:0, behavior:'smooth' }); $('departTime').focus(); });

  // Boot
  (async()=>{
    $('date').value=todayStr();
    await loadByDate();
    const rows=await fetchEntries(); renderTable(rows); buildCharts(rows); buildSnapshot(rows); computeBreakdown();
  })();
</script>
</body>
</html>
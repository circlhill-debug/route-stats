<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Route Stats ‚Äî Supabase MVP</title>
<style>
  :root { --bg:#0f1115; --card:#141821; --border:#22262e; --text:#e8e8ea; --muted:#a6abb5; --brand:#2b7fff; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Inter,Segoe UI,Roboto,Arial,sans-serif}
  header{border-bottom:1px solid var(--border);padding:16px 20px}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  h1{margin:0;font-size:22px;letter-spacing:.2px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin:14px 0}
  .grid{display:grid;gap:12px}
  @media(min-width:900px){.grid-2{grid-template-columns:1.1fr .9fr}}
  label{font-size:13px;color:var(--muted)}
  input,select,textarea{width:100%;padding:12px;background:#0f131c;border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:15px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  button{background:var(--brand);color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  button.ghost{background:#202633;color:var(--text)}
  small{color:var(--muted)}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:8px 6px;text-align:left}
  th{color:var(--muted);font-weight:600}
  .right{text-align:right}
  .hidden{display:none}
</style>
</head>
<body>
<header><div class="wrap"><h1>üìà Route Stats ‚Äî Supabase MVP</h1></div></header>
<main class="wrap grid grid-2">
  <section class="card" id="authCard">
    <h3 style="margin:0 0 10px 0">Sign in</h3>
    <div class="grid" style="grid-template-columns:1fr auto">
      <div>
        <label>Email</label>
        <input id="email" type="email" placeholder="you@example.com" />
      </div>
      <div class="row" style="align-self:end">
        <button id="magic">Send magic link</button>
      </div>
      <small style="grid-column:1/-1;color:var(--muted)">You‚Äôll receive an email link. Open it on this device to stay signed in.</small>
    </div>
  </section>

  <section class="card hidden" id="appCard">
    <h3 style="margin:0 0 10px 0">Add Daily Entry</h3>
    <div class="grid" style="grid-template-columns:repeat(2,1fr);gap:10px">
      <div><label>Date</label><input id="date" type="date"></div>
      <div><label>Route (optional)</label><input id="route" type="text" placeholder="Primary / Aux / Amazon‚Ä¶"></div>
      <div><label>Start Time</label><input id="start" type="time" value="08:00"><small>Prefills 08:00 ‚Äî change if needed.</small></div>
      <div><label>End Time</label><input id="end" type="time" placeholder="--:--"></div>
      <div><label>Parcels</label><input id="parcels" type="number" min="0" value="0"></div>
      <div><label>Letters</label><input id="letters" type="number" min="0" value="0"></div>
      <div><label>Flats</label><input id="flats" type="number" min="0" value="0"></div>
      <div><label>Miles</label><input id="miles" type="number" step="0.1" min="0" value="0"></div>
      <div><label>Weather (notes)</label><input id="weather" type="text" placeholder="Sunny 72¬∞, light wind"></div>
      <div><label>Mood</label>
        <select id="mood"><option value="">‚Äî</option><option>üî• dialed in</option><option>üôÇ good</option><option>üòê meh</option><option>ü•µ cooked</option><option>üåßÔ∏è soggy</option></select>
      </div>
      <div style="grid-column:1/-1"><label>Notes</label><textarea id="notes" rows="2" placeholder="Anything notable‚Ä¶"></textarea></div>
      <div class="row" style="grid-column:1/-1;justify-content:space-between">
        <div class="row"><small>Total hours (auto): </small><strong id="hoursPreview">‚Äî</strong></div>
        <div class="row"><button id="save">Save entry</button><button id="signOut" class="ghost">Sign out</button></div>
      </div>
    </div>
  </section>

  <section class="card hidden" id="listCard">
    <h3 style="margin:0 0 10px 0">Recent Entries</h3>
    <div class="row" style="justify-content:space-between"><div></div><button id="refresh" class="ghost">Refresh</button></div>
    <div style="max-height:360px;overflow:auto;border:1px solid var(--border);border-radius:10px">
      <table id="tbl"><thead><tr>
        <th>Date</th><th>Route</th><th class="right">Hours</th><th class="right">Parcels</th><th class="right">Letters</th><th class="right">Flats</th><th class="right">Miles</th>
      </tr></thead><tbody></tbody></table>
    </div>
  </section>
</main>

<script type="module">
  // 1) Fill these with your Supabase values (Settings ‚Üí API)
  const SUPABASE_URL = 'https://ouwkdtiixkaydrtfdhnh.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im91d2tkdGlpeGtheWRydGZkaG5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMDc0NDksImV4cCI6MjA3MDU4MzQ0OX0.KI-dYG5_A8jvPEHSog3wlnLbIGYIHQR_4ztXHL2SzIg';

  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON, { auth: { persistSession: true } });

  // --- elements
  const $ = (id)=>document.getElementById(id);
  const authCard = $('authCard'), appCard = $('appCard'), listCard = $('listCard');
  const email = $('email'), magic = $('magic');
  const date = $('date'), route = $('route'), start = $('start'), end = $('end'), parcels = $('parcels'), letters = $('letters'), flats = $('flats'), miles = $('miles'), weather = $('weather'), mood = $('mood'), notes = $('notes'), hoursPreview = $('hoursPreview');
  const saveBtn = $('save'), signOutBtn = $('signOut'), refreshBtn = $('refresh');

  // --- auth UI
  magic.addEventListener('click', async ()=>{
    if (!email.value) return alert('Enter your email');
    const { error } = await supabase.auth.signInWithOtp({ email: email.value, options: { emailRedirectTo: window.location.href } });
    if (error) alert(error.message); else alert('Magic link sent! Check your email.');
  });

  signOutBtn.addEventListener('click', async ()=>{
    await supabase.auth.signOut();
    authCard.classList.remove('hidden'); appCard.classList.add('hidden'); listCard.classList.add('hidden');
  });

  // --- session boot
  supabase.auth.onAuthStateChange((_evt, session)=>{
    if (session?.user) { onAuthed(session.user); } else { authCard.classList.remove('hidden'); }
  });
  (async ()=>{ const { data: { session } } = await supabase.auth.getSession(); if (session?.user) onAuthed(session.user); else authCard.classList.remove('hidden'); })();

  function todayStr(){ return new Date().toISOString().slice(0,10); }
  function computeHours(){
    if (!start.value || !end.value) { hoursPreview.textContent='‚Äî'; return null; }
    const s = new Date(`${date.value}T${start.value}`); const e = new Date(`${date.value}T${end.value}`);
    let h = (e - s)/3600000; if (h<0) h+=24; const val = Math.round(h*100)/100; hoursPreview.textContent = val.toFixed(2); return val;
  }
  start.addEventListener('input', computeHours); end.addEventListener('input', computeHours);

  async function onAuthed(user){
    authCard.classList.add('hidden'); appCard.classList.remove('hidden'); listCard.classList.remove('hidden');
    date.value = todayStr();
    await refresh();
  }

  // --- save entry (INSERT)
  saveBtn.addEventListener('click', async ()=>{
    const hours = computeHours();
    const payload = {
      user_id: (await supabase.auth.getUser()).data.user.id,
      work_date: date.value,
      route: route.value || null,
      start_time: start.value || null,
      end_time: end.value || null,
      hours: hours,
      parcels: +parcels.value || 0,
      letters: +letters.value || 0,
      flats: +flats.value || 0,
      miles: +miles.value || 0,
      weather_json: weather.value ? { note: weather.value } : null,
      mood: mood.value || null,
      notes: notes.value || null
    };

    const { error } = await supabase.from('entries').insert(payload);
    if (error) { alert(error.message); return; }
    alert('Saved');
    end.value=''; hoursPreview.textContent='‚Äî'; notes.value = weather.value = ''; parcels.value=letters.value=flats.value=miles.value=0; route.value='';
    await refresh();
  });

  // --- list entries (SELECT)
  async function refresh(){
    const uid = (await supabase.auth.getUser()).data.user.id;
    const { data, error } = await supabase.from('entries').select('*').eq('user_id', uid).order('work_date', { ascending:false }).limit(50);
    if (error) { console.error(error); return; }
    const tbody = document.querySelector('#tbl tbody');
    tbody.innerHTML = '';
    for (const r of data){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.work_date}</td><td>${r.route||''}</td><td class="right">${r.hours?.toFixed? r.hours.toFixed(2): (r.hours??'')}</td><td class="right">${r.parcels||0}</td><td class="right">${r.letters||0}</td><td class="right">${r.flats||0}</td><td class="right">${r.miles||0}</td>`;
      tbody.appendChild(tr);
    }
  }
  refreshBtn.addEventListener('click', refresh);
</script>
</body>
</html>

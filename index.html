<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Route Stats ‚Äî Dashboard</title>
<!-- ROUTE STATS (Anon Auth). Exact Time Split + Quick-Tap Timers + Off-Day Autofill -->
<style>
  :root{ --bg:#0f1115; --card:#141821; --border:#22262e; --text:#e8e8ea; --muted:#a6abb5; --brand:#2b7fff; --good:#88f0a7; --bad:#ff9aa8; --warn:#ffd08a }
  [data-theme="sunrise"]{ --bg:#fff7f0; --card:#fff; --border:#e7d9cc; --text:#222; --muted:#7a6d61; --brand:#ff6a3d; --good:#1a8735; --bad:#b21634; --warn:#b26f00 }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Inter,Segoe UI,Roboto,Arial,sans-serif}
  header{border-bottom:1px solid var(--border);padding:14px 16px}
  .wrap{max-width:1080px;margin:0 auto;padding:16px}
  h1{margin:0;font-size:20px;letter-spacing:.2px}
  .grid{display:grid;gap:12px}
  @media(min-width:960px){.grid-2{grid-template-columns:1.1fr .9fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
  label{font-size:13px;color:var(--muted)}
  input,select,textarea{width:100%;padding:12px;background:transparent;border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:15px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  button{background:var(--brand);color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  button.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
  small{color:var(--muted)}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:8px 6px;text-align:left}
  th{color:var(--muted);font-weight:600}
  .right{text-align:right}
  .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);padding:6px 8px;border-radius:999px;background:transparent}
  .stat{display:flex;flex-direction:column;gap:4px;padding:10px;border:1px solid var(--border);border-radius:12px}
  .up{color:var(--good)} .down{color:var(--bad)} .warn{color:var(--warn)}
  canvas{background:transparent;border:1px solid var(--border);border-radius:10px;padding:8px}
  .fab{position:fixed;right:16px;bottom:16px;z-index:10}
  /* diagnostics ribbon */
  #diag{position:sticky;top:0;z-index:999;background:#111; color:#ddd; font:12px/1.3 system-ui; padding:6px 10px; border-bottom:1px solid #222}
  #diag b{color:#fff}
</style>
</head>
<body>
<div id="diag">ROUTE STATS ¬∑ Supabase: <b id="dConn">‚Ä¶</b> ¬∑ Auth: <b id="dAuth">‚Ä¶</b> ¬∑ Write test: <b id="dWrite">‚Äî</b></div>
<header>
  <div class="wrap row" style="justify-content:space-between">
    <h1>üìà ROUTE STATS ‚Äî Dashboard</h1>
    <div class="row">
      <select id="themeSel" class="ghost"><option value="midnight">Midnight</option><option value="sunrise">Sunrise</option></select>
      <button id="signOut" class="ghost">Sign out</button>
    </div>
  </div>
</header>
<main class="wrap grid grid-2">
  <!-- SNAPSHOT -->
  <section class="card">
    <div class="row" style="justify-content:space-between;align-items:flex-start">
      <div class="row" style="gap:8px;align-items:stretch">
        <div class="stat"><small>Expected End</small><strong id="expEnd" style="font-size:20px">‚Äî</strong><small id="expMeta" style="color:var(--muted)">DOW avg ‚Äî</small></div>
        <div class="stat"><small>Expected Parcels</small><strong id="expParcels" style="font-size:20px">‚Äî</strong><small id="expParcelsMeta" style="color:var(--muted)">vs wk</small></div>
      </div>
      <div class="row" style="gap:8px;align-items:stretch">
        <div class="stat"><small>Hours (wk)</small><div><strong id="wkHours">‚Äî</strong> <span id="wkHoursDelta" class="pill">‚Äî</span></div></div>
        <div class="stat"><small>Volume (wk)</small><div><strong id="wkVol">‚Äî</strong> <span id="wkVolDelta" class="pill">‚Äî</span></div></div>
      </div>
    </div>
  </section>

  <!-- FORM -->
  <section class="card">
    <h3 style="margin:0 0 8px 0">Add Entry</h3>

    <!-- Quick-tap timers -->
    <div class="row" style="margin:6px 0 10px 0">
      <button id="btnStartNow" class="ghost">Start Timer (office)</button>
      <button id="btnStreetNow" class="ghost">Hit Street (now)</button>
      <button id="btnClockNow" class="ghost">Clock Out (now)</button>
    </div>

    <div class="grid" style="grid-template-columns:repeat(2,1fr);gap:10px">
      <div><label>Date</label><input id="date" type="date"></div>
      <div><label>Route</label><input id="route" type="text" placeholder="Primary / Aux / Amazon‚Ä¶"></div>

      <div><label>Start Time</label><input id="start" type="time" value="08:00"></div>
      <div><label>End Time</label><input id="end" type="time" placeholder="--:--"></div>

      <!-- Time Split (exact times) -->
      <div><label>Office Start</label><input id="officeStart" type="time" placeholder="--:--"></div>
      <div><label>Hit Street</label><input id="departTime" type="time" placeholder="--:--"></div>
      <div><label>Return to Office (optional)</label><input id="returnTime" type="time" placeholder="--:--"></div>

      <div><label>Parcels</label><input id="parcels" type="number" min="0" value="0"></div>
      <div><label>Letters</label><input id="letters" type="number" min="0" value="0"></div>
      <div><label>Flats</label><input id="flats" type="number" min="0" value="0"></div>
      <div><label>Miles</label><input id="miles" type="number" step="0.1" min="0" value="0"></div>
      <div><label>Weather (notes)</label><input id="weather" type="text" placeholder="Sunny 72¬∞, light wind"></div>
      <div><label>Mood</label><select id="mood"><option value="">‚Äî</option><option>üî• dialed in</option><option>üôÇ good</option><option>üòê meh</option><option>ü•µ cooked</option><option>üåßÔ∏è soggy</option><option>üõë off</option></select></div>
      <div style="grid-column:1/-1"><label>Notes</label><textarea id="notes" rows="2" placeholder="Anything notable‚Ä¶"></textarea></div>

      <div class="row" style="grid-column:1/-1;justify-content:space-between">
        <div class="row">
          <label class="pill"><input id="offDay" type="checkbox"> Off day</label>
          <span class="pill"><small>Total hours:</small> <strong id="hoursPreview">‚Äî</strong></span>
        </div>
        <div class="row"><button id="save">Save</button></div>
      </div>
    </div>
  </section>

  <!-- CHARTS -->
  <section class="card"><h3 style="margin:0 0 8px 0">Averages by Day of Week</h3><canvas id="dowChart" height="180"></canvas></section>
  <section class="card"><h3 style="margin:0 0 8px 0">Parcels Over Time</h3><canvas id="parcelsChart" height="180"></canvas></section>

  <!-- TABLE -->
  <section class="card" style="grid-column:1/-1">
    <div class="row" style="justify-content:space-between"><h3 style="margin:0">Recent Entries</h3><button id="exportCsv" class="ghost">Export CSV</button></div>
    <div style="max-height:340px;overflow:auto;border:1px solid var(--border);border-radius:10px">
      <table id="tbl"><thead><tr>
        <th>Date</th><th>Route</th><th>Status</th><th class="right">Hours</th><th class="right">Office/Route (h)</th><th class="right">Parcels</th><th class="right">Letters</th><th class="right">Flats</th><th class="right">Miles</th>
      </tr></thead><tbody></tbody></table>
    </div>
  </section>
</main>
<button class="fab" id="fab">+ Add Entry</button>

<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ==== PASTE YOUR PROJECT VALUES ====
  const SUPABASE_URL  = 'https://ouwkdtiixkaydrtfdhnh.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im91d2tkdGlpeGtheWRydGZkaG5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMDc0NDksImV4cCI6MjA3MDU4MzQ0OX0.KI-dYG5_A8jvPEHSog3wlnLbIGYIHQR_4ztXHL2SzIg';
  // ===================================

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON, { auth: { persistSession:true } });
  const $ = id => document.getElementById(id);
  const DateTime = luxon.DateTime;

  // Theme
  const themeSel = $('themeSel');
  themeSel.value = localStorage.getItem('rs.theme')||'midnight';
  document.documentElement.dataset.theme = themeSel.value;
  themeSel.addEventListener('change',()=>{ document.documentElement.dataset.theme = themeSel.value; localStorage.setItem('rs.theme', themeSel.value); });

  // Diagnostics
  const dConn=$('dConn'), dAuth=$('dAuth'), dWrite=$('dWrite');
  (async ()=>{ try{ await fetch(SUPABASE_URL,{mode:'no-cors'}); dConn.textContent='Connected'; }catch{ dConn.textContent='Error'; }})();

  // Ensure anonymous session
  (async function ensureAnon(){
    const { data:{ session } } = await sb.auth.getSession();
    if (session) { dAuth.textContent='Session'; return; }
    const { error } = await sb.auth.signInAnonymously();
    dAuth.textContent = error ? 'Auth error' : 'Session';
    if (error) console.error('Anon sign-in failed:', error.message);
  })();

  // Elements
  const date=$('date'), route=$('route'), start=$('start'), end=$('end'), parcels=$('parcels'), letters=$('letters'), flats=$('flats'), miles=$('miles'), weather=$('weather'), mood=$('mood'), notes=$('notes'), hoursPreview=$('hoursPreview'), offDay=$('offDay');
  const officeStart=$('officeStart'), departTime=$('departTime'), returnTime=$('returnTime');
  const expEnd=$('expEnd'), expMeta=$('expMeta'), expParcels=$('expParcels'), expParcelsMeta=$('expParcelsMeta'), wkHours=$('wkHours'), wkHoursDelta=$('wkHoursDelta'), wkVol=$('wkVol'), wkVolDelta=$('wkVolDelta');

  function todayStr(){ return DateTime.now().toISODate(); }
  date.value = todayStr();

  function computeHours(){
    if (offDay.checked) { hoursPreview.textContent='0.00'; return 0; }
    if (!start.value || !end.value) { hoursPreview.textContent='‚Äî'; return null; }
    const s = DateTime.fromISO(`${date.value}T${start.value}`);
    const e = DateTime.fromISO(`${date.value}T${end.value}`);
    let h = (e.toMillis()-s.toMillis())/3600000; if (h<0) h+=24; const v = Math.round(h*100)/100; hoursPreview.textContent=v.toFixed(2); return v;
  }

  function computeSplitMinutes(){
    const d = date.value; const toDT = (t)=> t ? DateTime.fromISO(`${d}T${t}`) : null;
    const os=toDT(officeStart.value), dp=toDT(departTime.value), co=toDT(end.value);
    let officeMin=null, routeMin=null;
    if (os && dp){ let diff=(dp.toMillis()-os.toMillis())/60000; if(diff<0) diff+=1440; officeMin=Math.round(diff); }
    if (dp && co){ let diff=(co.toMillis()-dp.toMillis())/60000; if(diff<0) diff+=1440; routeMin=Math.round(diff); }
    return { officeMin, routeMin };
  }

  ;[start,end,date,offDay,officeStart,departTime,returnTime].forEach(el=>el.addEventListener('input', computeHours));

  // Off day autofill: set End Time to now, zero counts; hours stays 0
  offDay.addEventListener('change', ()=>{
    const nowHHMM = (()=>{ const d=new Date(); const hh=String(d.getHours()).padStart(2,'0'); const mm=String(d.getMinutes()).padStart(2,'0'); return `${hh}:${mm}`; })();
    if (offDay.checked){ end.value = nowHHMM; parcels.value=letters.value=flats.value=miles.value=0; mood.value='üõë off'; hoursPreview.textContent='0.00'; }
  });

  // Quick-tap buttons
  function nowHHMM(){ const d=new Date(); return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; }
  $('btnStartNow').addEventListener('click',()=>{ const n=nowHHMM(); if(!start.value) start.value=n; if(!officeStart.value) officeStart.value=n; computeHours(); });
  $('btnStreetNow').addEventListener('click',()=>{ const n=nowHHMM(); departTime.value=n; if(!start.value) start.value=n; computeHours(); });
  $('btnClockNow').addEventListener('click',()=>{ const n=nowHHMM(); end.value=n; computeHours(); });

  // Save
  $('save').addEventListener('click', async ()=>{
    const { data:{ user } } = await sb.auth.getUser();
    dAuth.textContent = user? 'Session' : 'No session';

    const payload = {
      user_id: user?.id,
      work_date: date.value,
      route: route.value || null,
      start_time: offDay.checked ? null : (start.value||null),
      end_time:   offDay.checked ? null : (end.value||null),
      hours:      offDay.checked ? 0 : computeHours(),
      parcels:    offDay.checked ? 0 : (+parcels.value||0),
      letters:    offDay.checked ? 0 : (+letters.value||0),
      flats:      offDay.checked ? 0 : (+flats.value||0),
      miles:      offDay.checked ? 0 : (+miles.value||0),
      weather_json: weather.value ? { note: weather.value } : null,
      mood:        mood.value || (offDay.checked ? 'üõë off' : null),
      notes:       notes.value || null,
      status:      offDay.checked ? 'off' : 'worked',
      office_start: officeStart.value || null,
      depart_time:  departTime.value  || null,
      return_time:  returnTime.value  || null
    };

    const split = computeSplitMinutes();
    if (split) {
      if (split.officeMin!=null) payload.office_minutes = (split.officeMin/60).toFixed(2);
      if (split.routeMin !=null) payload.route_minutes  = (split.routeMin /60).toFixed(2);
    }

    const { error } = await sb.from('entries').insert(payload);
    dWrite.textContent = error ? 'Failed' : 'OK';
    if (error) { alert(error.message); return; }

    // reset a few fields; keep date & start for convenience
    end.value=''; officeStart.value=''; departTime.value=''; returnTime.value='';
    parcels.value=letters.value=flats.value=miles.value=0; weather.value=''; notes.value=''; offDay.checked=false; hoursPreview.textContent='‚Äî';

    const rows = await fetchEntries();
    renderTable(rows); buildCharts(rows); buildSnapshot(rows);
  });

  // Fetch & render
  async function fetchEntries(){
    const { data:{ user } } = await sb.auth.getUser();
    if(!user){ return []; }
    const { data, error } = await sb.from('entries').select('*').eq('user_id', user.id).order('work_date', { ascending:false }).limit(200);
    if (error) { console.error(error); return []; }
    return data;
  }

  function renderTable(rows){
    const tbody = document.querySelector('#tbl tbody');
    tbody.innerHTML='';
    for (const r of rows.slice(0,160)){
      const officeH = (r.office_minutes!=null) ? (Number(r.office_minutes).toFixed(2)) : '';
      const routeH  = (r.route_minutes !=null) ? (Number(r.route_minutes ).toFixed(2)) : '';
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.work_date}</td><td>${r.route||''}</td><td>${r.status||'worked'}</td><td class="right">${r.hours?.toFixed? r.hours.toFixed(2): (r.hours??'')}</td><td class="right">${officeH && routeH ? `${officeH}/${routeH}` : ''}</td><td class="right">${r.parcels||0}</td><td class="right">${r.letters||0}</td><td class="right">${r.flats||0}</td><td class="right">${r.miles||0}</td>`;
      tbody.appendChild(tr);
    }
  }

  // CSV export (includes split fields)
  $('exportCsv').addEventListener('click', async ()=>{
    const rows = await fetchEntries();
    const headers = ['work_date','route','status','start_time','end_time','hours','office_start','depart_time','return_time','office_minutes','route_minutes','parcels','letters','flats','miles','mood','notes','created_at'];
    const lines = [headers.join(',')];
    for (const r of rows){
      const vals = headers.map(h=>{ const v=r[h]; if(v==null) return ''; const s=String(v).replace(/"/g,'""'); return /[",\n]/.test(s)? `"${s}"`: s; });
      lines.push(vals.join(','));
    }
    const blob = new Blob([lines.join('\n')],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='route-stats.csv'; a.click();
  });

  // Charts
  let dowChart, parcelsChart; function destroyCharts(){ [dowChart,parcelsChart].forEach(c=>c&&c.destroy()); }
  function buildCharts(rows){
    destroyCharts(); const workRows = rows.filter(r=>r.status!=='off');
    const byDow = Array.from({length:7},()=>({h:0,c:0}));
    for (const r of workRows){ if(r.hours!=null){ const dow=new Date(r.work_date).getDay(); byDow[dow].h+=Number(r.hours); byDow[dow].c++; } }
    const dowLabels=['Sun','Mon','Tue','Wed','Thu','Fri','Sat']; const dowData=byDow.map(x=>x.c? +(x.h/x.c).toFixed(2):0);
    dowChart=new Chart(document.getElementById('dowChart'),{type:'bar',data:{labels:dowLabels,datasets:[{label:'Avg Hours',data:dowData}]},options:{responsive:true,plugins:{legend:{display:false}}}});
    const sorted=[...rows].sort((a,b)=>a.work_date.localeCompare(b.work_date));
    parcelsChart=new Chart(document.getElementById('parcelsChart'),{type:'line',data:{labels:sorted.map(r=>r.work_date),datasets:[{label:'Parcels',data:sorted.map(r=>r.parcels||0)}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{x:{ticks:{maxTicksLimit:8}}}}});
  }

  // Snapshot
  function pct(a,b){ if(b===0||b==null) return null; return ((a-b)/b)*100; }
  function hhmmFromHours(baseDateStr, hrs){ if(hrs==null) return '‚Äî'; const d=DateTime.fromISO(baseDateStr).set({hour:8,minute:0}); const end=d.plus({hours:hrs}); return end.toFormat('h:mm a'); }
  function buildSnapshot(rows){
    const today=DateTime.now(); const dow=today.weekday%7; const workRows=rows.filter(r=>r.status!=='off');
    const hoursByDow=Array.from({length:7},()=>[]), parcelsByDow=Array.from({length:7},()=>[]);
    for(const r of workRows){ const d=DateTime.fromISO(r.work_date).weekday%7; if(r.hours!=null) hoursByDow[d].push(Number(r.hours)); parcelsByDow[d].push(Number(r.parcels||0)); }
    const avg=arr=>arr.length?arr.reduce((a,b)=>a+b,0)/arr.length:null;
    const dowAvgH=hoursByDow.map(avg), dowAvgP=parcelsByDow.map(avg);
    const expH=dowAvgH[dow], expP=dowAvgP[dow];
    expEnd.textContent = expH? hhmmFromHours(today.toISODate(), expH) : '‚Äî';
    expMeta.textContent = `${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][dow]} avg ${expH?expH.toFixed(2)+'h':'‚Äî'}`;
    expParcels.textContent = expP? Math.round(expP) : '‚Äî';

    const startW=today.startOf('week'); const lastStart=startW.minus({weeks:1}); const lastEnd=startW.minus({days:1});
    const thisW=workRows.filter(r=> DateTime.fromISO(r.work_date) >= startW);
    const lastW=workRows.filter(r=> DateTime.fromISO(r.work_date) >= lastStart && DateTime.fromISO(r.work_date) <= lastEnd);
    const sum=(arr,fn)=>arr.reduce((t,x)=>t+(fn(x)||0),0);
    const hThis=sum(thisW,r=>r.hours), hLast=sum(lastW,r=>r.hours);
    const vThis=sum(thisW,r=>(r.parcels||0)+(r.letters||0)+(r.flats||0));
    const vLast=sum(lastW,r=>(r.parcels||0)+(r.letters||0)+(r.flats||0));
    wkHours.textContent=(hThis||0).toFixed(2); wkVol.textContent=vThis||0;
    const dh=pct(hThis,hLast), dv=pct(vThis,vLast); const fmt=p=>p==null?'‚Äî':(p>=0?`‚Üë ${p.toFixed(0)}%`:`‚Üì ${Math.abs(p).toFixed(0)}%`);
    wkHoursDelta.textContent=fmt(dh); wkVolDelta.textContent=fmt(dv);
    wkHoursDelta.className='pill '+(dh==null?'':dh>=0?'up':'down');
    wkVolDelta.className='pill '+(dv==null?'':dv>=0?'up':'down');
    expParcelsMeta.textContent=dv==null?'‚Äî':(dv>=0?'‚Üë vs wk':'‚Üì vs wk');
  }

  // Realtime (optional; requires DB ‚Üí Replication ‚Üí Realtime enabled for public)
  try{ sb.channel('entries-watch').on('postgres_changes',{ event:'*', schema:'public', table:'entries' }, async()=>{ const rows=await fetchEntries(); renderTable(rows); buildCharts(rows); buildSnapshot(rows); }).subscribe(); }catch(e){ console.warn('Realtime not enabled:', e?.message||e); }

  // UX bits
  $('fab').addEventListener('click',()=>{ window.scrollTo({ top:0, behavior:'smooth' }); $('start').focus(); });
  $('signOut').addEventListener('click', ()=> sb.auth.signOut().then(()=>location.reload()));

  // Boot
  (async()=>{ $('date').value=todayStr(); const rows=await fetchEntries(); renderTable(rows); buildCharts(rows); buildSnapshot(rows); })();
</script>
</body>
</html>
